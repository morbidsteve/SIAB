#cloud-config
# SIAB Cloud-Init Configuration for Rocky Linux
# This config prepares a Rocky Linux system and installs SIAB automatically
#
# Usage with MAAS:
# 1. Upload this as cloud-init user data in MAAS
# 2. Deploy Rocky Linux machine
# 3. Machine will auto-configure and install SIAB

# Set hostname
hostname: siab
fqdn: siab.local

# Configure users
users:
  - name: siab
    groups: wheel
    sudo: ALL=(ALL) NOPASSWD:ALL
    shell: /bin/bash
    lock_passwd: false
    # Password: siab123 (change in production!)
    # Generated with: openssl passwd -6
    passwd: $6$tG1taXOEijQglAha$G00nFUXQWq1zyLwdzwCPyz/wCWbPPaZtYXxqOIsgcGWgmkSeQX3M8A6g1Q/uyu8aTQ9dsHWx2L2agYA0zyUtW0

# Configure SSH
ssh_pwauth: true
disable_root: false
ssh_authorized_keys:
  - ssh-rsa AAAAB3NzaC1yc2E... # Add your SSH public key here

# Package management
package_upgrade: true
package_reboot_if_required: true

packages:
  - git
  - curl
  - wget
  - vim
  - htop
  - net-tools
  - firewalld
  - iscsi-initiator-utils
  - nfs-utils

# Disk partitioning (optional - adjust for your needs)
# disk_setup:
#   /dev/sda:
#     table_type: gpt
#     layout: true
#     overwrite: true

# Filesystem setup
# fs_setup:
#   - label: data
#     filesystem: ext4
#     device: /dev/sda2
#     partition: auto

# Mount points
# mounts:
#   - ["/dev/sda2", "/var/lib/longhorn", "ext4", "defaults", "0", "2"]

# Write files
write_files:
  # SIAB installation configuration
  - path: /etc/siab/install-config.env
    permissions: '0644'
    content: |
      # SIAB Installation Configuration
      SIAB_DOMAIN=siab.local
      SIAB_ADMIN_EMAIL=admin@siab.local
      SIAB_SINGLE_NODE=true
      SIAB_SKIP_MONITORING=false
      SIAB_MINIO_SIZE=20Gi

  # Auto-install script
  - path: /usr/local/bin/install-siab.sh
    permissions: '0755'
    content: |
      #!/bin/bash
      set -euo pipefail

      echo "SIAB Auto-Installation Starting..."
      echo "Timestamp: $(date)"

      # Wait for network
      echo "Waiting for network..."
      while ! ping -c 1 github.com &>/dev/null; do
        sleep 5
      done

      # Clone SIAB repository
      echo "Cloning SIAB repository..."
      cd /opt
      git clone https://github.com/morbidsteve/SIAB.git || {
        echo "Repository already exists, pulling latest..."
        cd SIAB
        git pull origin main
      }

      cd SIAB

      # Load configuration
      if [ -f /etc/siab/install-config.env ]; then
        source /etc/siab/install-config.env
        export SIAB_DOMAIN SIAB_ADMIN_EMAIL SIAB_SINGLE_NODE SIAB_SKIP_MONITORING SIAB_MINIO_SIZE
      fi

      # Run installation
      echo "Running SIAB installation..."
      ./install.sh 2>&1 | tee /var/log/siab-cloud-init-install.log

      echo "SIAB installation complete!"
      echo "Access services at https://<service>.${SIAB_DOMAIN}"

  # System tuning for Kubernetes
  - path: /etc/sysctl.d/99-kubernetes.conf
    permissions: '0644'
    content: |
      # Kubernetes tuning
      net.bridge.bridge-nf-call-iptables=1
      net.bridge.bridge-nf-call-ip6tables=1
      net.ipv4.ip_forward=1
      vm.swappiness=0
      fs.inotify.max_user_instances=512
      fs.inotify.max_user_watches=524288

  # Disable swap (required for Kubernetes)
  - path: /etc/systemd/system/disable-swap.service
    permissions: '0644'
    content: |
      [Unit]
      Description=Disable Swap
      After=local-fs.target

      [Service]
      Type=oneshot
      ExecStart=/usr/sbin/swapoff -a
      ExecStart=/bin/sed -i '/swap/d' /etc/fstab
      RemainAfterExit=yes

      [Install]
      WantedBy=multi-user.target

# Run commands
runcmd:
  # System configuration
  - echo "Configuring system for SIAB..."

  # Disable swap
  - swapoff -a
  - sed -i '/swap/d' /etc/fstab

  # Enable and configure firewalld
  - systemctl enable firewalld
  - systemctl start firewalld

  # Load kernel modules for Kubernetes
  - modprobe br_netfilter
  - modprobe overlay
  - modprobe ip_vs
  - modprobe ip_vs_rr
  - modprobe ip_vs_wrr
  - modprobe ip_vs_sh

  # Make modules persistent
  - |
    cat <<EOF > /etc/modules-load.d/kubernetes.conf
    br_netfilter
    overlay
    ip_vs
    ip_vs_rr
    ip_vs_wrr
    ip_vs_sh
    EOF

  # Apply sysctl settings
  - sysctl --system

  # Enable disable-swap service
  - systemctl daemon-reload
  - systemctl enable disable-swap
  - systemctl start disable-swap

  # Create SIAB directories
  - mkdir -p /opt/siab
  - mkdir -p /etc/siab
  - mkdir -p /var/log/siab

  # Set SELinux to permissive (required for RKE2)
  - setenforce 0 || true
  - sed -i 's/^SELINUX=enforcing/SELINUX=permissive/' /etc/selinux/config || true

  # Install SIAB (run in background so cloud-init doesn't wait)
  - nohup /usr/local/bin/install-siab.sh > /var/log/siab-install.log 2>&1 &

# Power state
# Reboot after configuration (optional)
# power_state:
#   mode: reboot
#   message: "Rebooting after cloud-init completion"
#   timeout: 30
#   condition: true

# Final message
final_message: |
  ╔════════════════════════════════════════════════════════════════╗
  ║  Cloud-Init Complete - SIAB Installation Starting             ║
  ╚════════════════════════════════════════════════════════════════╝

  System: $DISTRIB_DESCRIPTION
  Uptime: $UPTIME

  SIAB installation is running in the background.
  Monitor progress: tail -f /var/log/siab-install.log

  Installation will take 15-20 minutes.

  After completion, access services at:
    - Keycloak:  https://keycloak.siab.local
    - MinIO:     https://minio.siab.local
    - Grafana:   https://grafana.siab.local
    - Dashboard: https://dashboard.siab.local

  Add to your /etc/hosts:
    <IP_ADDRESS>  keycloak.siab.local minio.siab.local grafana.siab.local dashboard.siab.local

---
# SIAB Application Catalog Deployment
# Deploys the web-based catalog for browsing and deploying pre-configured apps

apiVersion: v1
kind: Namespace
metadata:
  name: siab-catalog
  labels:
    istio-injection: enabled
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: catalog-apps
  namespace: siab-catalog
data:
  # Apps directory will be mounted here
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: catalog-backend
  namespace: siab-catalog
spec:
  replicas: 2
  selector:
    matchLabels:
      app: catalog-backend
  template:
    metadata:
      labels:
        app: catalog-backend
    spec:
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        fsGroup: 1000
      containers:
        - name: api
          image: python:3.11-slim
          command:
            - "/bin/sh"
            - "-c"
            - |
              pip install --no-cache-dir -r /app/requirements.txt &&
              python /app/catalog-api.py
          ports:
            - containerPort: 5000
              name: http
          env:
            - name: FLASK_ENV
              value: "production"
          volumeMounts:
            - name: app-code
              mountPath: /app
            - name: apps-data
              mountPath: /app/apps
          resources:
            requests:
              cpu: 100m
              memory: 128Mi
            limits:
              cpu: 500m
              memory: 512Mi
          securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: false
            capabilities:
              drop:
                - ALL
      volumes:
        - name: app-code
          configMap:
            name: catalog-backend-code
        - name: apps-data
          hostPath:
            path: /opt/siab/catalog/apps
            type: DirectoryOrCreate
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: catalog-frontend
  namespace: siab-catalog
spec:
  replicas: 2
  selector:
    matchLabels:
      app: catalog-frontend
  template:
    metadata:
      labels:
        app: catalog-frontend
    spec:
      securityContext:
        runAsNonRoot: true
        runAsUser: 101  # nginx user
        fsGroup: 101
      containers:
        - name: nginx
          image: nginx:1.25-alpine
          ports:
            - containerPort: 8080
              name: http
          volumeMounts:
            - name: html
              mountPath: /usr/share/nginx/html
            - name: nginx-config
              mountPath: /etc/nginx/conf.d/default.conf
              subPath: default.conf
          resources:
            requests:
              cpu: 50m
              memory: 64Mi
            limits:
              cpu: 200m
              memory: 128Mi
          securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            capabilities:
              drop:
                - ALL
      volumes:
        - name: html
          hostPath:
            path: /opt/siab/catalog/frontend/public
            type: DirectoryOrCreate
        - name: nginx-config
          configMap:
            name: catalog-frontend-config
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: catalog-frontend-config
  namespace: siab-catalog
data:
  default.conf: |
    server {
        listen 8080;
        server_name _;
        root /usr/share/nginx/html;
        index index.html;

        location / {
            try_files $uri $uri/ /index.html;
        }

        location /api/ {
            proxy_pass http://catalog-backend:5000/api/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }
    }
---
apiVersion: v1
kind: Service
metadata:
  name: catalog-backend
  namespace: siab-catalog
spec:
  selector:
    app: catalog-backend
  ports:
    - port: 5000
      targetPort: 5000
      name: http
---
apiVersion: v1
kind: Service
metadata:
  name: catalog-frontend
  namespace: siab-catalog
spec:
  selector:
    app: catalog-frontend
  ports:
    - port: 80
      targetPort: 8080
      name: http
---
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: catalog
  namespace: istio-system
spec:
  hosts:
    - "catalog.siab.local"
  gateways:
    - siab-gateway
  http:
    - route:
        - destination:
            host: catalog-frontend.siab-catalog.svc.cluster.local
            port:
              number: 80
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: catalog-deployer
rules:
  - apiGroups: ["siab.io"]
    resources: ["siabapplications"]
    verbs: ["get", "list", "create", "update", "delete"]
  - apiGroups: [""]
    resources: ["namespaces"]
    verbs: ["get", "list"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: catalog-deployer
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: catalog-deployer
subjects:
  - kind: ServiceAccount
    name: default
    namespace: siab-catalog
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: catalog-deployer
  namespace: siab-catalog

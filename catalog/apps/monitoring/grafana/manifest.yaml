apiVersion: siab.io/v1alpha1
kind: SIABApplication
metadata:
  name: grafana
  namespace: monitoring
spec:
  image: grafana/grafana:10.2.2
  replicas: 1
  port: 3000

  env:
    - name: GF_SECURITY_ADMIN_PASSWORD
      valueFrom:
        secretKeyRef:
          name: grafana-secret
          key: admin-password
    - name: GF_AUTH_GENERIC_OAUTH_ENABLED
      value: "true"
    - name: GF_AUTH_GENERIC_OAUTH_NAME
      value: "Keycloak"

  resources:
    requests:
      cpu: "100m"
      memory: "256Mi"
    limits:
      cpu: "500m"
      memory: "1Gi"

  security:
    scanOnDeploy: true
    blockCriticalVulns: true

  storage:
    enabled: true
    size: "10Gi"
    mountPath: "/var/lib/grafana"

  ingress:
    enabled: true
    hostname: grafana.siab.local
    tls: true

  auth:
    enabled: true
    requiredRoles:
      - admin
      - viewer
---
apiVersion: v1
kind: Secret
metadata:
  name: grafana-secret
  namespace: monitoring
type: Opaque
stringData:
  admin-password: "admin123"  # Change in production!

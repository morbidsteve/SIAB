---
# RequestAuthentication for user-deployed apps
# This validates JWT tokens from Keycloak when present
apiVersion: security.istio.io/v1
kind: RequestAuthentication
metadata:
  name: user-apps-jwt-auth
  namespace: istio-system
spec:
  selector:
    matchLabels:
      istio: ingress-user
  jwtRules:
  - issuer: "https://keycloak.siab.local/realms/siab"
    jwksUri: "https://keycloak.siab.local/realms/siab/protocol/openid-connect/certs"
    audiences:
    - "siab-dashboard"
    - "siab-apps"
    - "account"
    forwardOriginalToken: true
    fromHeaders:
    - name: Authorization
      prefix: "Bearer "
    fromCookies:
    - "siab_token"
---
# AuthorizationPolicy to require valid JWT for deployed user apps
# Denies requests without valid JWT tokens to protected apps
apiVersion: security.istio.io/v1
kind: AuthorizationPolicy
metadata:
  name: require-jwt-user-apps
  namespace: istio-system
spec:
  selector:
    matchLabels:
      istio: ingress-user
  action: DENY
  rules:
  - from:
    - source:
        notRequestPrincipals: ["*"]  # Deny if no valid JWT principal
    to:
    - operation:
        hosts:
        - "nextcloud.siab.local"
        - "wireshark.siab.local"
        # Add more deployed app hostnames as needed
---
# Allow access to system services without JWT (they handle their own auth)
apiVersion: security.istio.io/v1
kind: AuthorizationPolicy
metadata:
  name: allow-system-services
  namespace: istio-system
spec:
  selector:
    matchLabels:
      istio: ingress-user
  action: ALLOW
  rules:
  - to:
    - operation:
        hosts:
        - "siab.local"
        - "dashboard.siab.local"
        - "catalog.siab.local"
        - "deployer.siab.local"

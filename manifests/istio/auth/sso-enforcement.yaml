---
# SIAB SSO Enforcement Policies
# These policies enforce Keycloak authentication for all applications
# Using Istio's ext_authz to validate requests through OAuth2 Proxy

# =============================================================================
# External Authorization Configuration
# =============================================================================

# Extension provider configuration is done via IstioOperator mesh config
# This EnvoyFilter adds the ext_authz filter for OAuth2 Proxy
---
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: oauth2-proxy-ext-authz
  namespace: istio-system
spec:
  workloadSelector:
    labels:
      istio: ingress-user
  configPatches:
  # Lua filter to redirect non-auth hosts through auth.siab.local/oauth2/start
  # This ensures CSRF cookies are set on the same domain as the callback
  - applyTo: HTTP_FILTER
    match:
      context: GATEWAY
      listener:
        filterChain:
          filter:
            name: "envoy.filters.network.http_connection_manager"
            subFilter:
              name: "envoy.filters.http.router"
    patch:
      operation: INSERT_BEFORE
      value:
        name: envoy.filters.http.lua
        typed_config:
          "@type": type.googleapis.com/envoy.extensions.filters.http.lua.v3.Lua
          default_source_code:
            inline_string: |
              function envoy_on_request(request_handle)
                -- Store the original host for use in response
                local host = request_handle:headers():get(":authority")
                request_handle:streamInfo():dynamicMetadata():set("lua", "original_host", host)
              end

              function envoy_on_response(response_handle)
                local status = response_handle:headers():get(":status")
                local location = response_handle:headers():get("location")

                -- Get the original request host
                local original_host = response_handle:streamInfo():dynamicMetadata():get("lua")
                if original_host then
                  original_host = original_host["original_host"]
                end

                -- Only modify if NOT from auth.siab.local and is a redirect to Keycloak
                if original_host and original_host ~= "auth.siab.local" then
                  if status == "302" and location and string.find(location, "keycloak.siab.local") then
                    -- Redirect to auth.siab.local/oauth2/start instead
                    local rd = "https://" .. original_host .. "/"
                    local new_location = "https://auth.siab.local/oauth2/start?rd=" .. rd
                    response_handle:headers():replace("location", new_location)
                  end
                end
              end
  # External authorization filter for OAuth2 Proxy
  - applyTo: HTTP_FILTER
    match:
      context: GATEWAY
      listener:
        filterChain:
          filter:
            name: "envoy.filters.network.http_connection_manager"
            subFilter:
              name: "envoy.filters.http.router"
    patch:
      operation: INSERT_BEFORE
      value:
        name: envoy.filters.http.ext_authz
        typed_config:
          "@type": type.googleapis.com/envoy.extensions.filters.http.ext_authz.v3.ExtAuthz
          failure_mode_allow: false
          transport_api_version: V3
          http_service:
            server_uri:
              uri: http://oauth2-proxy.oauth2-proxy.svc.cluster.local:80
              cluster: outbound|80||oauth2-proxy.oauth2-proxy.svc.cluster.local
              timeout: 10s
            path_prefix: "/oauth2/auth"
            authorization_request:
              # Add headers from original request to auth request
              headers_to_add:
              - key: x-forwarded-host
                value: "%REQ(:authority)%"
              - key: x-forwarded-uri
                value: "%REQ(:path)%"
              - key: x-forwarded-proto
                value: "%REQ(:scheme)%"
              allowed_headers:
                patterns:
                - exact: "cookie"
                - exact: "authorization"
            authorization_response:
              # Headers to pass to upstream when auth succeeds (200)
              allowed_upstream_headers:
                patterns:
                - exact: "authorization"
                - exact: "x-auth-request-user"
                - exact: "x-auth-request-email"
                - exact: "x-auth-request-groups"
                - exact: "x-auth-request-access-token"
                - exact: "set-cookie"
              # Headers to send to client when auth fails (401/403)
              allowed_client_headers:
                patterns:
                - exact: "set-cookie"
                - exact: "location"
                - exact: "www-authenticate"
                - exact: "content-type"
              # Also allow appending cookies on success
              allowed_client_headers_on_success:
                patterns:
                - exact: "set-cookie"
          clear_route_cache: true
          status_on_error:
            code: 503
---
# EnvoyFilter to bypass ext_authz for auth.siab.local (OAuth2 Proxy endpoints)
# This prevents redirect loops during the OAuth2 callback flow
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: disable-authz-for-oauth2
  namespace: istio-system
spec:
  workloadSelector:
    labels:
      istio: ingress-user
  configPatches:
  # Add per-route config to disable ext_authz for auth.siab.local
  - applyTo: HTTP_ROUTE
    match:
      context: GATEWAY
      routeConfiguration:
        vhost:
          name: "auth.siab.local:443"
    patch:
      operation: MERGE
      value:
        typed_per_filter_config:
          envoy.filters.http.ext_authz:
            "@type": type.googleapis.com/envoy.extensions.filters.http.ext_authz.v3.ExtAuthzPerRoute
            disabled: true

---
# =============================================================================
# Authorization Policies
# =============================================================================

# Allow access to OAuth2 Proxy endpoints without auth (for login flow)
apiVersion: security.istio.io/v1
kind: AuthorizationPolicy
metadata:
  name: allow-oauth2-endpoints
  namespace: istio-system
spec:
  selector:
    matchLabels:
      istio: ingress-user
  action: ALLOW
  rules:
  - to:
    - operation:
        hosts:
        - "auth.siab.local"
        - "auth.siab.local:*"
---
# Allow access to Keycloak (handles its own authentication)
apiVersion: security.istio.io/v1
kind: AuthorizationPolicy
metadata:
  name: allow-keycloak
  namespace: istio-system
spec:
  selector:
    matchLabels:
      istio: ingress-admin
  action: ALLOW
  rules:
  - to:
    - operation:
        hosts:
        - "keycloak.siab.local"
        - "keycloak.siab.local:*"
---
# Allow access to SIAB Dashboard (has built-in Keycloak auth)
apiVersion: security.istio.io/v1
kind: AuthorizationPolicy
metadata:
  name: allow-siab-dashboard
  namespace: istio-system
spec:
  selector:
    matchLabels:
      istio: ingress-user
  action: ALLOW
  rules:
  - to:
    - operation:
        hosts:
        - "siab.local"
        - "siab.local:*"
        - "dashboard.siab.local"
        - "dashboard.siab.local:*"
---
# Allow access to App Deployer (has built-in Keycloak auth)
apiVersion: security.istio.io/v1
kind: AuthorizationPolicy
metadata:
  name: allow-deployer
  namespace: istio-system
spec:
  selector:
    matchLabels:
      istio: ingress-user
  action: ALLOW
  rules:
  - to:
    - operation:
        hosts:
        - "deployer.siab.local"
        - "deployer.siab.local:*"
        - "catalog.siab.local"
        - "catalog.siab.local:*"
---
# Allow access to Admin services (each has its own auth or Keycloak integration)
apiVersion: security.istio.io/v1
kind: AuthorizationPolicy
metadata:
  name: allow-admin-services
  namespace: istio-system
spec:
  selector:
    matchLabels:
      istio: ingress-admin
  action: ALLOW
  rules:
  - to:
    - operation:
        hosts:
        - "grafana.siab.local"
        - "grafana.siab.local:*"
        - "k8s-dashboard.siab.local"
        - "k8s-dashboard.siab.local:*"
        - "minio.siab.local"
        - "minio.siab.local:*"
        - "longhorn.siab.local"
        - "longhorn.siab.local:*"

---
# =============================================================================
# JWT Authentication Rules (validates tokens when present)
# =============================================================================

# RequestAuthentication for User Gateway
apiVersion: security.istio.io/v1
kind: RequestAuthentication
metadata:
  name: keycloak-jwt-user-gateway
  namespace: istio-system
spec:
  selector:
    matchLabels:
      istio: ingress-user
  jwtRules:
  - issuer: "https://keycloak.siab.local/realms/siab"
    # Use internal cluster URL for JWKS to avoid external network issues
    jwksUri: "http://keycloak.keycloak.svc.cluster.local:80/realms/siab/protocol/openid-connect/certs"
    audiences:
    - "siab-dashboard"
    - "siab-oauth2-proxy"
    - "siab-apps"
    - "account"
    forwardOriginalToken: true
    outputPayloadToHeader: x-jwt-payload
    fromHeaders:
    - name: Authorization
      prefix: "Bearer "
    - name: X-Auth-Request-Access-Token
    # Note: fromCookies is not supported in Istio 1.20.x
    # JWT tokens are passed via headers from OAuth2 Proxy instead
---
# RequestAuthentication for Admin Gateway
apiVersion: security.istio.io/v1
kind: RequestAuthentication
metadata:
  name: keycloak-jwt-admin-gateway
  namespace: istio-system
spec:
  selector:
    matchLabels:
      istio: ingress-admin
  jwtRules:
  - issuer: "https://keycloak.siab.local/realms/siab"
    jwksUri: "http://keycloak.keycloak.svc.cluster.local:80/realms/siab/protocol/openid-connect/certs"
    audiences:
    - "siab-admin-services"
    - "siab-dashboard"
    - "account"
    forwardOriginalToken: true
    outputPayloadToHeader: x-jwt-payload
    fromHeaders:
    - name: Authorization
      prefix: "Bearer "
    # Note: fromCookies is not supported in Istio 1.20.x
---
# =============================================================================
# Allow Deployed Apps
# =============================================================================
# Allow access to all deployed apps (they are protected by ext_authz/OAuth2 Proxy)
# This enables dynamically deployed apps to be accessible via user-gateway
apiVersion: security.istio.io/v1
kind: AuthorizationPolicy
metadata:
  name: allow-deployed-apps
  namespace: istio-system
spec:
  selector:
    matchLabels:
      istio: ingress-user
  action: ALLOW
  rules:
  - to:
    - operation:
        hosts:
        - "*.siab.local"
        - "*.siab.local:*"
        - "*.apps.siab.local"
        - "*.apps.siab.local:*"
